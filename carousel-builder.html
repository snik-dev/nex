<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MNE.com Carousel Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              navy: "#002366",
              gold: "#ffc72c",
              danger: "#b91c1c"
            }
          }
        }
      };
    </script>

    <!-- libs -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
      .badge {
        position: absolute;
        top: 6px;
        left: 6px;
        background: #ffc72c;
        color: #002366;
        font-weight: 700;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 9999px;
      }
      .rating span {
        color: #ffc72c;
        font-size: 0.875rem;
      }
      .placeholder {
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        font-size: 0.875rem;
        color: #6b7280;
      }
      .promo-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        background: #002366;
        color: #fff;
        font-size: 0.625rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
      }
    </style>
  </head>

  <body class="bg-gray-100 min-h-screen p-6 flex flex-col gap-6">
    <!-- HEADER -->
    <header class="bg-navy text-white p-4 rounded-lg shadow mb-4">
      <h1 class="text-3xl font-semibold">MNE.com Carousel Generator</h1>
    </header>

    <!-- MAIN GRID -->
    <div class="grid lg:grid-cols-3 gap-6 w-full">
      <!-- BUILDER -->
      <div class="lg:col-span-1 space-y-6">
        <form id="builder" class="space-y-4">
          <div>
            <label class="block font-medium mb-1">Carousel Title</label>
            <input id="carouselTitle" type="text" class="w-full border rounded p-2" />
          </div>

          <div class="flex items-center gap-2">
            <input id="showReviews" type="checkbox" class="h-4 w-4" checked />
            <label for="showReviews">Include review count</label>
          </div>

          <div>
            <label class="block font-medium mb-1">Template Type</label>
            <select id="templateSelect" class="border rounded p-2 w-full">
              <option value="standard">Standard – Brand, Name, MSRP, Price</option>
              <option value="promo">Promo – Name, Price, Badge</option>
              <option value="minimal">Minimal – Image &amp; Name</option>
            </select>
          </div>

          <div id="itemsContainer" class="space-y-6"></div>

          <button id="addItem" type="button" class="w-full px-4 py-2 bg-gold text-navy rounded shadow">
            Add Item (0/10)
          </button>

          <hr class="my-4" />

          <!-- CSV -->
          <h2 class="font-semibold text-lg mb-2">Bulk CSV Upload</h2>
          <input type="file" id="csvFile" accept=".csv" class="mb-2" />
          <br />
          <a
            href="https://snik-dev.github.io/nex/template.csv"
            class="text-navy underline text-sm"
            target="_blank"
          >
            Download CSV template
          </a>
        </form>
      </div>

      <!-- PREVIEW -->
      <div class="lg:col-span-2">
        <h2 class="text-xl font-semibold mb-2">
          Live Preview <span class="text-sm text-gray-600">(drag to reorder)</span>
        </h2>
        <div id="previewArea" class="flex flex-col gap-4 bg-white border rounded p-4 min-h-[260px]"></div>
        <div id="a11yReport" class="mt-4 text-danger text-sm"></div>
      </div>
    </div>

    <!-- OUTPUT + IMPORT -->
    <div class="grid lg:grid-cols-2 gap-6 mt-6">
      <div>
        <h2 class="text-xl font-semibold mb-2">Generated HTML</h2>
        <textarea id="output" class="w-full h-64 border p-2 font-mono text-xs"></textarea>
        <button id="copyCode" class="mt-2 px-4 py-2 bg-navy text-white rounded shadow">Copy</button>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">HTML Input (Import)</h2>
        <textarea id="importHtml" class="w-full h-64 border p-2 font-mono text-xs"></textarea>
        <button id="importBtn" class="mt-2 px-4 py-2 bg-navy text-white rounded shadow">Import</button>
      </div>
    </div>

    <!-- ITEM TEMPLATE -->
    <template id="itemTemplate">
      <div class="border p-4 rounded space-y-3 bg-white shadow" data-item>
        <div class="flex justify-between items-center">
          <span class="font-bold itemIndex">#</span>
          <button type="button" class="removeItem px-2 py-1 bg-red-500 text-white rounded">Remove</button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <input
            type="url"
            placeholder="Product Link URL"
            class="productLink border rounded p-2 col-span-2 md:col-span-3"
          />
          <input
            type="text"
            placeholder="Product Name"
            class="productName border rounded p-2 col-span-2 md:col-span-3"
          />
          <input type="text" placeholder="Brand" class="productBrand border rounded p-2" />
          <input
            type="url"
            placeholder="Image URL"
            class="productImage border rounded p-2 col-span-2"
          />
          <input type="text" placeholder="MSRP" class="productMsrp border rounded p-2" />
          <input type="text" placeholder="Price" class="productPrice border rounded p-2" />
          <input
            type="number"
            step="0.5"
            min="0"
            max="5"
            placeholder="Rating"
            class="productRating border rounded p-2"
          />
          <input type="number" placeholder="Reviews" class="productReviews border rounded p-2" />

          <label class="col-span-2 md:col-span-3 text-sm font-medium">Promo Badge (optional)</label>
          <select class="productBadge border rounded p-2 col-span-2 md:col-span-3">
            <option value="">None</option>
            <option value="clearance">Clearance</option>
            <option value="last-chance">Last Chance</option>
            <option value="new">New</option>
            <option value="exclusive">NEX Exclusive</option>
          </select>
        </div>
      </div>
    </template>

    <!-- CORE JS -->
    <script>
      $(function () {
        const maxItems = 10;
        const placeholderImg =
          '<div class="placeholder">No Image Added</div>';

        /* ---------- helpers ---------- */
        function updateCounts() {
          const c = $("#itemsContainer [data-item]").length;
          $("#addItem")
            .text(`Add Item (${c}/${maxItems})`)
            .prop("disabled", c >= maxItems)
            .toggleClass("opacity-50 cursor-not-allowed", c >= maxItems);

          $("#itemsContainer [data-item]").each((i, el) =>
            $(el).find(".itemIndex").text(i + 1)
          );
        }

        function addItem(data = {}) {
          if ($("#itemsContainer [data-item]").length >= maxItems) return;

          const node = document
            .getElementById("itemTemplate")
            .content.cloneNode(true);
          $("#itemsContainer").append(node);

          const $wrap = $("#itemsContainer [data-item]").last();
          Object.entries(data).forEach(([k, v]) =>
            $wrap.find(`.product${k.charAt(0).toUpperCase() + k.slice(1)}`).val(v)
          );

          updateCounts();
          refresh();
        }

        function ratingHTML(val) {
          const r = parseFloat(val) || 0;
          const full = Math.floor(r);
          const half = r % 1 >= 0.5;
          let html = "";
          for (let i = 0; i < full; i++) html += "★";
          if (half) html += "☆";
          return `<div class="rating">${html
            .split("")
            .map((s) => `<span>${s}</span>`)
            .join("")}</div>`;
        }

        function badgeHTML(type) {
          if (!type) return "";
          const map = {
            clearance: "Clearance",
            "last-chance": "Last Chance",
            new: "New",
            exclusive: "NEX Exclusive",
          };
          return `<span class="promo-badge" data-type="${type}">${map[type]}</span>`;
        }

        /* ---------- events ---------- */
        $("#addItem").on("click", () => addItem());

        $("#itemsContainer").on("click", ".removeItem", function () {
          $(this).closest("[data-item]").remove();
          updateCounts();
          refresh();
        });

        $("#builder").on("input change", "input,select", refresh);

        $("#csvFile").on("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const rdr = new FileReader();
          rdr.onload = (ev) => {
            const rows = ev.target.result.split(/\r?\n/).filter((x) => x.trim());
            const header = rows.shift().split(",");
            $("#itemsContainer").empty();
            rows.forEach((line) => {
              const vals = line.split(",");
              const obj = {};
              header.forEach((h, i) => (obj[h.trim()] = vals[i] || ""));
              addItem(obj);
            });
          };
          rdr.readAsText(file);
        });

        $("#importBtn").on("click", () => {
          const raw = $("#importHtml").val();
          if (!raw.trim()) {
            alert("Paste an HTML snippet first.");
            return;
          }

          const doc = new DOMParser().parseFromString(raw, "text/html");

          const ttl = doc.querySelector(".sg-content-item .bold");
          if (ttl) $("#carouselTitle").val(ttl.textContent.trim());

          const cards = doc.querySelectorAll(".product-card_content");
          if (!cards.length) {
            alert("No .product-card_content items found.");
            return;
          }

          $("#itemsContainer").empty();

          cards.forEach((c) => {
            const alt = c.querySelector(".ratingsStars")?.getAttribute("alt") || "";
            const match = alt.match(/([0-5](?:_[05])?)/);

            addItem({
              link: c.querySelector("a")?.getAttribute("href") || "",
              image: c.querySelector("img")?.getAttribute("src") || "",
              brand: c.querySelector(".product-card_brand")?.textContent.trim() || "",
              name: c.querySelector(".product-card_name")?.textContent.trim() || "",
              msrp: c
                .querySelector(".product-card_price_msrp_strike")
                ?.textContent.trim() || "",
              price: c
                .querySelector(".product-card_price_regular span")
                ?.textContent.trim() || "",
              reviews:
                c.querySelector(".product-card_reviews span")?.textContent.match(/\d+/)?.[0] ||
                "",
              rating: match ? match[1].replace("_", ".") : "",
              badge: c.querySelector(".promo-badge")?.dataset.type || "",
            });
          });
        });

        /* ---------- preview + output ---------- */
        function makeCard(d, idx, tpl, showRev) {
          const img = d.image
            ? `<img src="${d.image}" alt="${d.name || "product"}">`
            : placeholderImg;

          const name = d.name ? `<div class="product-card_name">${d.name}</div>` : "";
          const brand = d.brand
            ? `<p class="product-card_brand font-semibold"><a href="${d.link}">${d.brand}</a></p>`
            : "";
          const msrp = d.msrp
            ? `<div class="product-card_price_msrp">Retail Price: <span class="product-card_price_msrp_strike"> ${d.msrp} </span></div>`
            : "";
          const price = d.price
            ? `<div class="product-card_price_regular">NEX Price <span> ${d.price} </span></div>`
            : "";

          let body = "";
          if (tpl === "minimal") body = name;
          else if (tpl === "promo") body = `${name}${price}`;
          else body = `${brand}${name}${msrp}${price}`;

          const reviews = showRev
            ? `<div class="mt-2 flex items-center gap-1">${ratingHTML(d.rating)}<span>(${d.reviews})</span></div>`
            : "";

          return `
            <div class="relative w-40" data-idx="${idx}">
              <div class="badge">${idx + 1}</div>
              ${badgeHTML(d.badge)}
              <a href="${d.link}">${img}</a>
              <div class="text-sm mt-2">${body}${reviews}</div>
            </div>`;
        }

        function buildOutput(arr, tpl, showRev) {
          const inner = arr
            .map((d, i) => {
              const img = d.image
                ? `<img src="${d.image}" alt="${d.name || "product"}">`
                : placeholderImg;

              const name = d.name ? `<div class="product-card_name">${d.name}</div>` : "";
              const brand = d.brand
                ? `<p class="product-card_brand"><a href="${d.link}">${d.brand}</a></p>`
                : "";
              const msrp = d.msrp
                ? `<div class="product-card_price_msrp">Retail Price: <span class="product-card_price_msrp_strike"> ${d.msrp} </span></div>`
                : "";
              const price = d.price
                ? `<div class="product-card_price_regular">NEX Price <span> ${d.price} </span></div>`
                : "";

              let body = "";
              if (tpl === "minimal") body = name;
              else if (tpl === "promo") body = `${name}${price}`;
              else body = `${brand}${name}${msrp}${price}`;

              const reviews = showRev
                ? `<div class="product-card_reviews mt-2 mb-2 d-flex align-items-center">${ratingHTML(
                    d.rating
                  )} <span class="ml-1">(${d.reviews})</span></div>`
                : "";

              return `
                <div class="product-card_content product-card_slider relative">
                  <span class="badge">${i + 1}</span>
                  ${badgeHTML(d.badge)}
                  <div class="product-card_content_images p-0 mb-3">
                    <a href="${d.link}">${img}</a>
                  </div>
                  <div class="product-card_content_description">
                    ${body}${reviews}
                  </div>
                </div>`;
            })
            .join("");

          const html = `
            <div class="sg-content col-12 row no-gutters">
              <div class="sg-content-item col-12 row align-items-center mx-0 my-4">
                <div class="col-12 bold mb-4" style="font-size:18px;">${$(
                  "#carouselTitle"
                ).val()}</div>
                <div class="owl-carousel recently-viewed-carousel owl-theme">${inner}</div>
              </div>
            </div>`;

          $("#output").val(html.trim());
        }

        function refresh() {
          const tpl = $("#templateSelect").val();
          const showR = $("#showReviews").is(":checked");

          const items = [];
          $("#itemsContainer [data-item]").each(function () {
            const $e = $(this);
            items.push({
              link: $e.find(".productLink").val(),
              name: $e.find(".productName").val(),
              brand: $e.find(".productBrand").val(),
              image: $e.find(".productImage").val(),
              msrp: $e.find(".productMsrp").val(),
              price: $e.find(".productPrice").val(),
              rating: $e.find(".productRating").val(),
              reviews: $e.find(".productReviews").val(),
              badge: $e.find(".productBadge").val(),
            });
          });

          $("#previewArea").html(
            items.map((d, i) => makeCard(d, i, tpl, showR)).join("")
          );

          const altMissing = $("#previewArea img[alt='']").length;
          $("#a11yReport").text(
            altMissing ? "Image missing alt text" : ""
          );

          buildOutput(items, tpl, showR);
        }

        const sortable = new Sortable(document.getElementById("previewArea"), {
          animation: 150,
          onEnd(evt) {
            const $items = $("#itemsContainer [data-item]");
            const moved = $items.eq(evt.oldIndex);
            if (evt.newIndex === 0)
              $("#itemsContainer").prepend(moved);
            else $items.eq(evt.newIndex).before(moved);
            updateCounts();
            refresh();
          },
        });

        $(document).on("click", "#copyCode", () =>
          navigator.clipboard.writeText($("#output").val())
        );

        /* first item */
        addItem();
      });
    </script>
  </body>
</html>
